<%- include('partials/layout_start', { title: 'Vendex Command Center', showCart: false,
  headerRightHtml: `<span class="text-sm text-muted-foreground hidden sm:inline">User:</span><span class="text-sm font-extrabold">Admin</span>
  <a href="/logout" class="chip bg-destructive/10 text-destructive hover:bg-destructive hover:text-white transition">Logout</a>`
}) %>

<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
  <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <div class="ui-card p-6 animate-enter">
      <div class="text-xs font-black uppercase tracking-[0.22em] text-muted-foreground">Total SKUs</div>
      <div class="text-3xl font-extrabold mt-2"><%= stats.totalProducts %></div>
    </div>

    <div class="ui-card p-6 animate-enter" style="animation-delay: 60ms;">
      <div class="text-xs font-black uppercase tracking-[0.22em] text-muted-foreground">Market Awareness</div>
      <div class="text-3xl font-extrabold mt-2">
        <%= stats.syncedCount %> <span class="text-sm font-extrabold text-muted-foreground">synced</span>
      </div>
    </div>

    <div class="ui-card p-6 animate-enter" style="animation-delay: 120ms;">
      <div class="text-xs font-black uppercase tracking-[0.22em] text-muted-foreground">Avg. Spread</div>
      <div class="text-3xl font-extrabold mt-2 <%= stats.avgSpread > 0 ? 'text-green-500' : 'text-destructive' %>">
        <%= stats.avgSpread %>%
      </div>
    </div>

    <div class="ui-card p-6 animate-enter border border-primary/25" style="animation-delay: 180ms;">
      <div class="text-xs font-black uppercase tracking-[0.22em] text-muted-foreground">Actions</div>
      <button
        class="mt-3 w-full btn-hero py-3 rounded-full font-extrabold shadow-lg hover:shadow-xl hover:-translate-y-0.5 active:scale-[0.98]
               transition-all duration-300 ease-emphasized"
        onclick="syncNow(this)">
        Force Market Sync
      </button>
    </div>
  </div>

  <div class="ui-card p-6 mb-8 animate-enter" style="animation-delay: 220ms;">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <div class="text-lg font-extrabold tracking-tight">Bulk Catalog Management</div>
        <div class="text-sm text-muted-foreground mt-1">Upload a CSV to sync prices, costs, and new inventory in bulk.</div>
      </div>

      <form id="importForm" class="flex items-center gap-2">
        <input type="file" id="csvFile" accept=".csv" required
          class="block w-full md:w-[260px] text-sm
                 file:mr-3 file:rounded-full file:border-0 file:px-4 file:py-2
                 file:bg-secondary-container/70 file:text-foreground file:font-extrabold
                 hover:file:bg-secondary-container/90
                 bg-secondary-container/30 border border-border/60 rounded-full px-3 py-2" />
        <button type="button" onclick="handleImport()"
          class="px-5 py-2.5 rounded-full bg-card/70 border border-border/60 font-extrabold
                 hover:bg-secondary-container/60 transition-all duration-300 ease-emphasized">
          Start Import
        </button>
      </form>
    </div>
  </div>

  <div class="ui-card overflow-hidden animate-enter" style="animation-delay: 260ms;">
    <div class="p-6 border-b border-border/60">
      <div class="text-lg font-extrabold tracking-tight">Live Inventory & Pricing Strategy</div>
      <div class="text-sm text-muted-foreground mt-1">Costs update immediately; spreads and margins are computed safely.</div>
    </div>

    <div class="overflow-x-auto no-scrollbar">
      <table class="min-w-full text-sm">
        <thead class="bg-secondary-container/30 text-muted-foreground">
          <tr class="text-left">
            <th class="px-6 py-4 font-black uppercase tracking-[0.18em] text-[11px]">Product</th>
            <th class="px-6 py-4 font-black uppercase tracking-[0.18em] text-[11px]">Cost</th>
            <th class="px-6 py-4 font-black uppercase tracking-[0.18em] text-[11px]">Our Price</th>
            <th class="px-6 py-4 font-black uppercase tracking-[0.18em] text-[11px]">Competitor</th>
            <th class="px-6 py-4 font-black uppercase tracking-[0.18em] text-[11px]">Spread</th>
            <th class="px-6 py-4 font-black uppercase tracking-[0.18em] text-[11px]">Real Margin</th>
            <th class="px-6 py-4 font-black uppercase tracking-[0.18em] text-[11px]">Actions</th>
          </tr>
        </thead>

        <tbody class="divide-y divide-border/40">
          <% products.forEach(p => { 
            let cost = p.cost || 0;
            let marginVal = '---'; 
            let marginClass = 'text-muted-foreground';

            if (p.price > 0 && cost > 0) {
              let m = ((p.price - cost) / p.price) * 100;
              marginVal = m.toFixed(1) + '%';
              if (m > 30) marginClass = 'text-green-500 font-extrabold';
              else if (m > 15) marginClass = 'text-yellow-500 font-extrabold';
              else marginClass = 'text-destructive font-extrabold';
            }

            let spreadVal = '---';
            let spreadClass = 'text-muted-foreground';
            if (p.custom_label_0) {
              let compPrice = parseFloat(p.custom_label_0);
              if (compPrice > 0) {
                let s = ((p.price - compPrice) / compPrice) * 100;
                spreadVal = s.toFixed(1) + '%';
                spreadClass = s > 10
                  ? 'bg-destructive/15 text-destructive font-extrabold border border-border/60'
                  : 'bg-green-500/15 text-green-500 font-extrabold border border-border/60';
              }
            }
          %>
            <tr class="hover:bg-secondary-container/20 transition-colors">
              <td class="px-6 py-4">
                <div class="font-extrabold leading-tight"><%= p.title %></div>
                <div class="text-xs text-muted-foreground mt-1">SKU: <span class="font-mono"><%= p.sku || 'N/A' %></span></div>
              </td>

              <td class="px-6 py-4">
                <div class="flex items-center gap-2">
                  <span class="text-muted-foreground font-extrabold">$</span>
                  <input type="number"
                    class="w-28 px-3 py-2 rounded-full bg-secondary-container/30 border border-border/60 outline-none
                           focus:ring-2 focus:ring-primary/30 focus:border-primary transition"
                    value="<%= cost %>"
                    onchange="updateCost('<%= p.id %>', this.value)" />
                </div>
              </td>

              <td class="px-6 py-4 font-extrabold">$<%= p.price.toFixed(2) %></td>

              <td class="px-6 py-4">
                <% if (p.custom_label_0) { %>
                  <div class="font-extrabold">$<%= parseFloat(p.custom_label_0).toFixed(2) %></div>
                  <div class="text-xs text-muted-foreground">via eBay</div>
                <% } else { %>
                  <span class="chip text-muted-foreground">Scanningâ€¦</span>
                <% } %>
              </td>

              <td class="px-6 py-4">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs <%= spreadClass %>">
                  <%= spreadVal %>
                </span>
              </td>

              <td class="px-6 py-4 <%= marginClass %>"><%= marginVal %></td>

              <td class="px-6 py-4">
                <button
                  class="px-4 py-2 rounded-full bg-card/70 border border-border/60 font-extrabold
                         hover:bg-secondary-container/60 transition-all duration-300 ease-emphasized"
                  onclick="window.open('/product/<%= p.id %>')">
                  View
                </button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
</section>

<script>
  async function syncNow(btn){
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = 'Syncing...';
    try{
      const res = await fetch('/admin/sync-now', { method: 'POST' });
      const data = await res.json();
      if(data.success){ alert('Market data refreshed successfully!'); location.reload(); }
      else alert('Error: ' + data.error);
    } catch(err){
      alert('Connection error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  }

  async function updateCost(id, newCost){
    try{
      await fetch('/admin/update-cost', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ productId:id, newCost:newCost })
      });
      location.reload();
    } catch(err){
      alert('Failed to save cost');
    }
  }

  async function handleImport(){
    const fileInput = document.getElementById('csvFile');
    if(!fileInput.files[0]) return alert("Please select a file first.");

    const formData = new FormData();
    formData.append('productCsv', fileInput.files[0]);

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = "Processing...";

    try{
      const res = await fetch('/admin/bulk-import', { method:'POST', body: formData });
      const data = await res.json();
      alert(data.message);
      location.reload();
    } catch(err){
      alert("Import failed. Check server logs.");
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  }
</script>

<%- include('partials/layout_end') %>
