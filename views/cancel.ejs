<%- include('partials/layout_start', { title: 'Vendex Command Center', showCart: false,
  headerRightHtml: `<span class="text-sm text-muted-foreground hidden sm:inline">User:</span><span class="text-sm font-extrabold">Admin</span>
  <a href="/logout" class="chip bg-destructive/10 text-destructive hover:bg-destructive hover:text-white transition">Logout</a>`
}) %>

<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
  <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <div class="ui-card p-6 animate-enter">
      <div class="text-xs font-black uppercase tracking-[0.22em] text-muted-foreground">Total SKUs</div>
      <div class="text-3xl font-extrabold mt-2"><%= stats.totalProducts %></div>
    </div>

    <div class="ui-card p-6 animate-enter" style="animation-delay: 60ms;">
      <div class="text-xs font-black uppercase tracking-[0.22em] text-muted-foreground">Market Awareness</div>
      <div class="text-3xl font-extrabold mt-2">
        <%= stats.syncedCount %> <span class="text-sm font-extrabold text-muted-foreground">synced</span>
      </div>
    </div>

    <div class="ui-card p-6 animate-enter" style="animation-delay: 120ms;">
      <div class="text-xs font-black uppercase tracking-[0.22em] text-muted-foreground">System Health</div>
      <div class="text-3xl font-extrabold mt-2 text-green-500">100%</div>
    </div>

    <div class="ui-card p-6 animate-enter" style="animation-delay: 180ms;">
      <div class="text-xs font-black uppercase tracking-[0.22em] text-muted-foreground">Actions</div>
      <div class="mt-2">
        <button onclick="forceSync()" id="syncBtn" class="w-full btn-soft text-sm py-2 font-bold">
          Force Market Sync
        </button>
      </div>
    </div>
  </div>

  <div class="grid lg:grid-cols-3 gap-8">
    <div class="lg:col-span-2 ui-card overflow-hidden animate-enter" style="animation-delay: 200ms;">
      <div class="p-6 border-b border-border flex justify-between items-center">
        <h2 class="text-xl font-extrabold">Inventory Intelligence</h2>
        <span class="text-xs font-mono text-muted-foreground">LIVE_DATA</span>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
          <thead>
            <tr class="bg-secondary-container/10">
              <th class="py-4 px-4 text-xs font-black uppercase tracking-wider text-muted-foreground border-b border-border">Product</th>
              <th class="py-4 px-4 text-xs font-black uppercase tracking-wider text-muted-foreground border-b border-border">Cost</th>
              <th class="py-4 px-4 text-xs font-black uppercase tracking-wider text-muted-foreground border-b border-border">Price</th>
              <th class="py-4 px-4 text-xs font-black uppercase tracking-wider text-muted-foreground border-b border-border">Margin</th>
              <th class="py-4 px-4 text-xs font-black uppercase tracking-wider text-muted-foreground border-b border-border">Market</th>
            </tr>
          </thead>
          <tbody>
            <% products.forEach(p => { 
               const margin = p.price && p.cost ? ((p.price - p.cost)/p.price * 100).toFixed(0) : 0;
               const marketPrice = p.custom_label_0 ? Number(p.custom_label_0).toFixed(2) : null;
               const isLowMargin = margin < 15;
            %>
            <tr class="border-b border-border hover:bg-secondary-container/30 transition group">
              <td class="py-4 px-4">
                <div class="font-bold line-clamp-1 text-sm"><%= p.title %></div>
                <div class="text-xs text-muted-foreground"><%= p.brand %></div>
              </td>
              <td class="py-4 px-4">
                <div class="flex items-center gap-1">
                  <span class="text-muted-foreground">$</span>
                  <input 
                    type="number" 
                    value="<%= p.cost || 0 %>" 
                    onchange="updateCost('<%= p.id %>', this.value)"
                    class="w-16 bg-transparent border-b border-transparent focus:border-primary outline-none font-mono text-sm transition hover:border-border"
                  />
                </div>
              </td>
              <td class="py-4 px-4 font-mono text-sm">$<%= p.price ? p.price.toFixed(2) : '0.00' %></td>
              <td class="py-4 px-4">
                <span class="chip text-xs px-2 py-1 <%= isLowMargin ? 'text-destructive bg-destructive/10' : 'text-green-600 bg-green-500/10' %>">
                  <%= margin %>%
                </span>
              </td>
              <td class="py-4 px-4 text-xs">
                <% if(marketPrice){ %>
                  <span class="text-muted-foreground">Comp:</span> <span class="font-bold">$<%= marketPrice %></span>
                <% } else { %>
                  <span class="text-muted-foreground/50 italic">Scanning...</span>
                <% } %>
              </td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>

    <div class="space-y-6 animate-enter" style="animation-delay: 300ms;">
      <div class="ui-card p-6">
        <h3 class="font-extrabold mb-4 text-lg">Quick Actions</h3>
        
        <div class="space-y-4">
          <div>
            <label class="text-xs font-bold text-muted-foreground uppercase mb-2 block">Bulk Import</label>
            <div class="flex gap-2">
              <input type="file" id="csvFile" accept=".csv" class="hidden" onchange="document.getElementById('fileName').innerText = this.files[0]?.name || 'Choose CSV'" />
              <button onclick="document.getElementById('csvFile').click()" class="btn-soft flex-1 text-sm py-2 truncate" id="fileName">Choose CSV</button>
              <button onclick="handleImport()" class="btn-hero text-sm py-2 px-4">Upload</button>
            </div>
            <p class="text-[10px] text-muted-foreground mt-2">Format: title, brand, price, cost, description, image</p>
          </div>
        </div>
      </div>
      
      <div class="ui-card p-6">
        <h3 class="font-extrabold mb-4 text-lg">System Logs</h3>
        <div class="bg-black/90 rounded-xl p-4 font-mono text-xs text-green-400 h-48 overflow-y-auto no-scrollbar space-y-1">
          <div>> System init... OK</div>
          <div>> Connecting to Mongo... OK</div>
          <div>> Watcher service... STANDBY</div>
          <div>> Brain service... ONLINE</div>
          <div class="text-muted-foreground">> Waiting for commands...</div>
        </div>
      </div>
    </div>
  </div>
</section>

<%- include('partials/layout_end') %>

<script>
  async function forceSync(){
    const btn = document.getElementById('syncBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = "Syncing...";
    
    try{
      const res = await fetch('/admin/sync-now', { method: 'POST' });
      const data = await res.json();
      if(data.success){ alert('Market data refreshed successfully!'); location.reload(); }
      else alert('Error: ' + data.error);
    } catch(err){
      alert('Connection error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  }

  async function updateCost(id, newCost){
    try{
      await fetch('/admin/update-cost', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ productId:id, newCost:newCost })
      });
      location.reload();
    } catch(err){
      alert('Failed to save cost');
    }
  }

  async function handleImport(){
    const fileInput = document.getElementById('csvFile');
    if(!fileInput.files[0]) return alert("Please select a file first.");

    const formData = new FormData();
    formData.append('productCsv', fileInput.files[0]);

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = "Processing...";

    try{
      const res = await fetch('/admin/bulk-import', { method:'POST', body: formData });
      const data = await res.json();
      alert(data.message);
      location.reload();
    } catch(err){
      alert("Import failed. Check server logs.");
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  }
</script>