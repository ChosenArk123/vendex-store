<script>
  // Cart state
  let cart = [];

  function loadCart(){
    const saved = localStorage.getItem('vendex_cart');
    if(saved){
      try { cart = JSON.parse(saved) || []; }
      catch { cart = []; }
    }
    updateCartUI();
  }

  function saveCart(){
    localStorage.setItem('vendex_cart', JSON.stringify(cart));
    updateCartUI();
  }

  function toggleCart(){
    const drawer = document.getElementById('cart-drawer');
    const backdrop = document.getElementById('cart-backdrop');
    if(!drawer || !backdrop) return; // ✅ prevents homepage breaking if markup missing

    const isOpen = !drawer.classList.contains('translate-x-full');
    if(isOpen){
      drawer.classList.add('translate-x-full');
      backdrop.classList.remove('opacity-100');
      setTimeout(()=>backdrop.classList.add('hidden'), 500);
    } else {
      backdrop.classList.remove('hidden');
      setTimeout(()=>{
        drawer.classList.remove('translate-x-full');
        backdrop.classList.add('opacity-100');
      }, 10);
    }
  }

  function updateQuantity(id, change){
    id = Number(id);
    const item = cart.find(i=>Number(i.id)===id);
    if(!item) return;
    item.quantity = Number(item.quantity || 0) + change;
    if(item.quantity <= 0) cart = cart.filter(i=>Number(i.id)!==id);
    saveCart();
  }

  function removeItem(id){
    id = Number(id);
    cart = cart.filter(i=>Number(i.id)!==id);
    saveCart();
  }

  function updateCartUI(){
    const container = document.getElementById('cart-items-container');
    const footer = document.getElementById('cart-footer');
    const badge = document.getElementById('cart-badge'); // may or may not exist

    if(!container || !footer){
      // page doesn't have drawer; still keep badge updated if present
      const totalItems = cart.reduce((a,i)=>a+Number(i.quantity||0),0);
      if(badge){
        badge.innerText = totalItems;
        totalItems>0 ? badge.classList.remove('hidden') : badge.classList.add('hidden');
      }
      return;
    }

    const totalItems = cart.reduce((a,i)=>a+Number(i.quantity||0),0);
    if(badge){
      badge.innerText = totalItems;
      totalItems>0 ? badge.classList.remove('hidden') : badge.classList.add('hidden');
    }

    if(cart.length===0){
      container.innerHTML = `<div class="text-muted-foreground">Your cart is empty</div>`;
      footer.classList.add('hidden');
      return;
    }

    container.innerHTML = cart.map(item => `
      <div class="flex gap-4 bg-secondary-container/30 rounded-2xl p-3">
        <img src="${item.image || ''}" class="w-20 h-20 object-cover rounded-xl flex-shrink-0" />
        <div class="flex-1 min-w-0">
          <div class="font-extrabold line-clamp-1">${item.title || 'Item'}</div>
          <div class="text-primary font-extrabold">$${Number(item.price || 0).toFixed(2)}</div>
        </div>
        <div class="flex flex-col items-end justify-between">
          <button onclick="removeItem(${Number(item.id)})" class="text-muted-foreground hover:text-destructive">✕</button>
          <div class="flex items-center gap-2 bg-card/60 rounded-full px-2 py-1 border border-border/50">
            <button onclick="updateQuantity(${Number(item.id)}, -1)" class="w-6 h-6 font-extrabold">-</button>
            <span class="w-4 text-center font-extrabold">${Number(item.quantity || 0)}</span>
            <button onclick="updateQuantity(${Number(item.id)}, 1)" class="w-6 h-6 font-extrabold">+</button>
          </div>
        </div>
      </div>
    `).join('');

    const subtotal = cart.reduce((a,i)=> a + (Number(i.price||0) * Number(i.quantity||0)), 0);
    const tax = subtotal * 0.1;

    document.getElementById('cart-subtotal').innerText = `$${subtotal.toFixed(2)}`;
    document.getElementById('cart-tax').innerText = `$${tax.toFixed(2)}`;
    document.getElementById('cart-total').innerText = `$${(subtotal+tax).toFixed(2)}`;
    footer.classList.remove('hidden');
  }

  async function checkout(){
    const button = document.querySelector('#cart-footer button');
    const original = button ? button.innerHTML : '';
    if(button){ button.innerText = "Processing..."; button.disabled = true; }

    try{
      const res = await fetch('/create-checkout-session', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ cart })
      });
      const data = await res.json();
      if(data.url) window.location.href = data.url;
      else throw new Error('No URL');
    } catch(err){
      alert('Checkout failed');
      if(button){ button.innerHTML = original; button.disabled = false; }
    }
  }

  // boot
  loadCart();
</script>
